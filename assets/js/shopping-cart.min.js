let userLoggedIn=!1;function checkLoginStatus(){isLoggedIn(function(t){t!==userLoggedIn?(userLoggedIn=t,userLoggedIn&&handleUserLogin()):updateCartUI(getCart())})}jQuery(document).ready(function(t){checkLoginStatus(),setInterval(checkLoginStatus,3e5),loadCart(),jQuery("#shoppingCart-page").length>0&&cartPageLoad();const a=new bootstrap.Offcanvas("#shoppingCartCanvas");t(document).on("click",".addCart",function(){const e=t(this).closest(".product-item"),r={id:e.data("id"),sku:e.data("sku"),name:e.find(".title").text().trim(),price:e.data("price"),originalPrice:e.data("original-price"),saleOff:e.data("saleoff"),image:e.find("img").attr("src"),category:e.data("category"),quantity:1};r.id&&r.price?(addToCart(r),a.show()):console.log("Product error")}),handleCartActions(),t(".btn-share-cart").on("click",function(){let a=getCart();if(0===a.length)return void siteNotify("Giỏ hàng của bạn đang trống. Không thể chia sẻ.","error");let e=t("#share-cart-link"),r=t("#share-cart-message"),n=(t("#shareCartModal"),t(".cart-shareon"));e.val(""),r.addClass("d-none").text(""),t.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"vcl_share_cart",nonce:ThemeVars.nonce,cart_data:JSON.stringify(a)},beforeSend:function(){r.removeClass("d-none alert-info alert-danger").addClass("alert-warning").text("Đang tạo liên kết...")},success:function(t){t.success?(e.val(t.data.share_url),n.data("url",t.data.share_url),r.removeClass("alert-warning").addClass("alert-info").text(t.data.message)):r.removeClass("alert-warning").addClass("alert-danger").text(t.data.message||"Có lỗi xảy ra khi chia sẻ giỏ hàng.")},error:function(){r.removeClass("alert-warning").addClass("alert-danger").text("Lỗi kết nối máy chủ khi chia sẻ giỏ hàng.")}})}),t("#copy-share-link-btn").on("click",function(){t("#share-cart-link").select(),document.execCommand("copy"),siteNotify("Đã sao chép liên kết!")});const e=new URLSearchParams(window.location.search);if(e.has("share_error")){const t=e.get("share_error");let a="";"no_id"===t?a="Liên kết chia sẻ giỏ hàng không hợp lệ.":"expired_or_invalid"===t&&(a="Giỏ hàng được chia sẻ đã hết hạn hoặc không tồn tại."),a&&(siteNotify(a,"error"),e.delete("share_error"),window.history.replaceState({},document.title,window.location.pathname+(e.toString()?"?"+e.toString():"")))}});const apiUrl=ThemeVars.ajaxurl;function getCart(){return JSON.parse(localStorage.getItem("cart"))||[]}function saveCart(t){localStorage.setItem("cart",JSON.stringify(t)),userLoggedIn&&syncCartWithServer(t)}function mergeCarts(t,a){let e=new Map;return[...t,...a].forEach(t=>{if(e.has(t.id)){let a=e.get(t.id);a.quantity=Math.max(a.quantity,t.quantity)}else e.set(t.id,{...t})}),Array.from(e.values())}function handleUserLogin(){jQuery.ajax({url:apiUrl,method:"POST",data:{action:"get_user_cart",nonce:ThemeVars.nonce},success:function(t){if(t.success){let a=t.data.cart||[],e=mergeCarts(getCart(),a);saveCart(e),updateCartUI(e)}}})}function syncCartWithServer(t){jQuery.ajax({url:apiUrl,method:"POST",data:{action:"update_user_cart",nonce:ThemeVars.nonce,cart:JSON.stringify(t)}})}function addToCart(t){let a=getCart(),e=a.find(a=>a.id===t.id);e?e.quantity+=t.quantity??1:a.push(t),saveCart(a),userLoggedIn&&syncCartWithServer(a),updateCartUI(a)}function removeCartItem(t){let a=getCart().filter(a=>a.id!==t);saveCart(a),updateCartUI(a)}function isLoggedIn(t){jQuery.ajax({url:apiUrl,method:"POST",data:{action:"check_user_login"},success:function(a){"function"==typeof t&&t(a.success)},error:function(){"function"==typeof t&&t(!1)}})}function updateCartUI(t){let a=jQuery("#shopping-cart"),e=jQuery("#cart-item-counter"),r=jQuery("#cart-items"),n=jQuery("#cart-total"),i=0,o=0,s=0;a.fadeOut(),r.empty(),t.forEach(t=>{i=t.price*t.quantity,o+=i,s+=t.quantity;let a="";if(t.attributes)for(const[e,r]of Object.entries(t.attributes))a+=`<div>${e}: ${r}</div>`;r.append(`\n          <li class="cart-item" data-id="${t.id}">\n                  <img src="${t.image}" alt="${t.name}" width="50" height="50" style="object-fit: cover;">\n                  <div class="cart-item-details">\n                    <p class="cart-item-name">${t.name}</p>\n                    <p class="cart-item-sku">${t.sku}</p>\n                    <div class="cart-item-attrs">${a}</div>\n                    <div class="d-flex justify-content-between">\n                        <div class="minicart-qty cartItem-qtyBox">\n                            <button class="qty-btn qty-minus" role="button"><i class="bi bi-dash-lg"></i></button>\n                            <input class="item-qty form-control border-0" value="${t.quantity}">\n                            <button class="qty-btn qty-plus" role="button"><i class="bi bi-plus-lg"></i></button>\n                        </div>\n                        <div class="cart-item-total">${i.toLocaleString()}<sup>₫</sup></div>\n                    </div>\n                  </div>\n                  <button class="remove-from-cart btn btn-danger btn-sm" data-product-id="${t.id}"><i class="bi bi-x-circle"></i></button>\n                </li>\n              `)}),n.html(o.toLocaleString()+"<sup>₫</sup>"),e.text(s),s?(jQuery("#empty-cart").hide(),a.fadeIn()):(a.hide(),jQuery("#empty-cart").fadeIn()),jQuery("#shoppingCart-page").length}function loadCart(){userLoggedIn?jQuery.ajax({url:apiUrl,method:"POST",data:{action:"get_user_cart",nonce:ThemeVars.nonce},success:function(t){if(t.success){let a=t.data.cart||[],e=getCart(),r=[];a.length&&e.length&&(r=mergeCarts(e,a)),r=a.length&&!e.length?a:e,saveCart(r),updateCartUI(r)}}}):updateCartUI(getCart())}function cartPageLoad(){if(!jQuery("#shoppingCart-page").length)return;const t=getCart();0!==t.length?jQuery.ajax({url:ThemeVars.ajaxurl,method:"POST",data:{action:"get_cart_products",cart:JSON.stringify(t),nonce:ThemeVars.nonce},beforeSend:function(){showLoading()},success:function(t){if(t.success){let a="";jQuery("#shoppingCart-page #cartPage-items").html(t.data.html),jQuery("#shoppingCart-page #cartPage-subtotal").html(t.data.subtotal_html),jQuery("#shoppingCart-page #cartPage-total").html(t.data.total_html);let e=!0;t.data.order_rules&&(jQuery(t.data.order_rules).each(function(t,r){a+=`<input type="radio" style="display: none;" ${e?"checked":""} name="order_pricing_rule" id="${r.pricing_rule}" value="${r.pricing_rule}"><label class="btn btn-outline-danger select_order_rules" role="button" for="${r.pricing_rule}"><i class="bi bi-ticket-detailed"></i> ${r.description}</label>`,e&&(e=!1)}),jQuery("#order_pricing_rule").html(a))}else console.error("Lỗi:",t.data),jQuery("#shoppingCart-page").html(`<p>${translations.cart_error}</p>`);hideLoading()},error:function(t){console.error("Lỗi khi tải thông tin sản phẩm:",t),jQuery("#shoppingCart-page").html(`<p>${translations.cart_error}</p>`),hideLoading()}}):jQuery("#shoppingCart-page").html(`<p>${translations.cart_no_item}</p>`)}function loadCartUI(t){0!==t.length?jQuery.ajax({url:ThemeVars.ajaxurl,method:"POST",data:{action:"get_cart_products",cart:JSON.stringify(t),nonce:ThemeVars.nonce},beforeSend:function(){showLoading()},success:function(t){t.success?(jQuery("#shoppingCart-page #cartPage-items").html(t.data.html),jQuery("#shoppingCart-page #cartPage-subtotal").html(t.data.subtotal_html),jQuery(".remove-from-cart").on("click",function(){removeCartItem(jQuery(this).data("product-id"))})):(console.error("Lỗi:",t.data),jQuery("#shoppingCart-page").html(`<p>${translations.cart_error}</p>`)),hideLoading()},error:function(t){console.error("Lỗi khi tải thông tin sản phẩm:",t),jQuery("#shoppingCart-page").html(`<p>${translations.cart_error}</p>`),hideLoading()}}):jQuery("#shoppingCart-page").html(`<p>${translations.cart_no_item}</p>`)}function updateCartItemTotal(t){const a=t.data("id"),e=(t.data("price"),parseInt(t.find(".item-qty").val()));updateCartQuantity(a,e)}function updateCartQuantity(t,a){let e=getCart(),r=e.findIndex(a=>a.id===t);-1!==r&&(e[r].quantity=a,saveCart(e),updateCartUI(e))}function handleCartActions(){jQuery(document).on("click",".qty-plus",function(){const t=jQuery(this).siblings(".item-qty");let a=parseInt(t.val())+1;t.val(a).trigger("change");jQuery(this).closest(".cartPage-item").data("product-id")}),jQuery(document).on("click",".qty-minus",function(){const t=jQuery(this).siblings(".item-qty");let a=parseInt(t.val());if(a>1){a-=1,t.val(a).trigger("change");jQuery(this).closest(".cartPage-item").data("product-id")}}),jQuery(document).on("change",".item-qty",function(){const t=jQuery(this).closest(".cartPage-item");let a=parseInt(jQuery(this).val());a<1&&(jQuery(this).val(1),a=1);updateCartQuantity(t.data("variation-sku")||t.data("id"),a),updateCartItemTotal(jQuery(this).closest(".cartPage-item")),cartPageLoad()}),jQuery(document).on("click",".remove-from-cart",function(){removeCartItem(jQuery(this).data("product-id")),cartPageLoad()}),jQuery(document).on("change",".minicart-qty .item-qty",function(){const t=jQuery(this).closest(".cart-item");let a=parseInt(jQuery(this).val());a<1&&(jQuery(this).val(1),a=1);updateCartQuantity(t.data("id"),a)})}