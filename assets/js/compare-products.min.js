jQuery(document).ready(function(e){let t=[],a=getSkusFromUrl();a.length>0?e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"load_product_comparison",product_skus:a,nonce:ThemeVars.nonce},success:function(e){e.success||siteNotify("Không thể tải dữ liệu sản phẩm")},error:function(){siteNotify("Lỗi kết nối, vui lòng thử lại")}}):(t=JSON.parse(localStorage.getItem("compareList"))||[],updateCompareListUI_page(t)),updateCompareListUI_page(t),e(window).scroll(function(){let t=e("#compare-header").offset().top+e("#compare-header").height()/2;e(window).scrollTop()>t?e("#compareHead-top").show().addClass("sticky"):e("#compareHead-top").removeClass("sticky").hide()})});let compare_title_list=[],compare_products_data=[];async function updateCompareListUI_page(e){let t=jQuery("#cmpProduct-item"),a=jQuery("#fullCompare-head"),c=jQuery("#compare-attributes"),s=`<div class="stick-df" onclick="">\n                <input type="checkbox" class="checkdiff-cb" id="checkdiff-cb2">\n                <label for="checkdiff-cb2">${translations.only_difference}</label>\n            </div>`;t.empty(),a.empty(),c.empty(),compare_title_list=[],compare_products_data=[],await Promise.all(e.map(async e=>{await loadProductDetails(e,t,a)})),jQuery(".fullCompare-title").html(compare_title_list.join("<h6>&</h6>")+s),createCompareAttributesTable(compare_products_data,c);for(let c=e.length;c<3;c++)t.append(`\n              <li class="formsg ">\n                <a href="#" class="cp-plus cp-plus_new"  data-bs-toggle="modal" data-bs-target="#searchProduct_modal">\n                  <i class="bi bi-plus-lg"></i><p>${translations.add_product}</p>\n                </a>\n              </li>\n            `),a.append(`<div class="cp-item-col" ><a href="#" class="cp-plus cp-plus_new"  data-bs-toggle="modal" data-bs-target="#searchProduct_modal">\n                  <i class="bi bi-plus-lg"></i><p>${translations.add_product}</p>\n                </a></div>`);newTitle="So sanh san phẩm",newState=e,window.history.pushState(newState,newTitle,generateCompareUrl(e))}function removeComparePage(e){let t=JSON.parse(localStorage.getItem("compareList"))||[];t=t.filter(t=>t.sku!==e),localStorage.setItem("compareList",JSON.stringify(t)),updateCompareListUI_page(t)}function loadProductDetails(e,t,a){return new Promise((c,s)=>{jQuery.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"get_product_by_sku",sku:e.sku,nonce:ThemeVars.nonce},success:function(i){if(i.success){let s=i.data;compare_products_data.push(s);let r=""!=s.discount?`<div class="sale-title">${s.discount}%</div>`:"",o=""!=s.sold?`<div class="qty-sold">Đã bán ${s.sold}</div>`:"",n=`\n                        <li>\n                            <img src="${s.image_url}" alt="${s.title}">\n                            <div>\n                                <a href="${e.url}" class="text-decoration-none text-body"><h3>${s.title}</h3></a>\n                                <div class="price">${s.html_price}</div>\n                            </div>\n                            <span class="remove-ic-compare" onclick="removeComparePage('${s.sku}');"><i class="bi bi-x-lg"></i></span>\n                            ${r}\n                        </li>\n                    `,l=`\n                        <div class="cp-item-col" >\n                            <img src="${s.image_url}" alt="${s.title}" class="mb-3">\n                            <a href="${e.url}" class="text-decoration-none text-body"><h6>${s.title}</h6></a>\n                            <div class="product-meta-text sku">${s.sku}</div>\n                            <div class="price">${s.html_price}</div>\n                            <span class="remove-ic-compare" onclick="removeComparePage('${s.sku}');"><i class="bi bi-x-lg"></i></span>\n                            ${r}${o}\n                        </div>\n                    `;t.append(n),a.append(l),compare_title_list.push(`<h5>${s.title}</h5>`),c()}else console.error("Lỗi: "+i.data),s("Lỗi: "+i.data)},error:function(){console.error("Lỗi AJAX"),s("Lỗi AJAX")}})})}function createCompareAttributesTable(e,t){function a(e,t){if(e.specifications&&Array.isArray(e.specifications)){const a=e.specifications.find(e=>e.spec_name===t);return a?a.spec_value:"-"}return"-"}t.empty();let c={};e.forEach(e=>{e.specifications&&Array.isArray(e.specifications)&&e.specifications.forEach(e=>{e.spec_name&&(c[e.spec_name]=!0)})});let s=jQuery("#checkdiff-cb1").is(":checked")||jQuery("#checkdiff-cb2").is(":checked");Object.keys(c).forEach(c=>{let i=e.map(e=>a(e,c)),r=i.length>0&&i.every(e=>e===i[0]);if(!s||!r){let s=jQuery('<div class="attribute-row"></div>');s.append(`<div class="attribute-name">${attributeTranslations[c]||c}</div>`),e.forEach(e=>{let t=a(e,c);s.append(`<div class="attribute-value">${t||"-"}</div>`)});let i=3-e.length;for(let e=0;e<i;e++)s.append('<div class="attribute-value empty-column"></div>');t.append(s)}})}function syncCheckboxes(e){jQuery(".checkdiff-cb").prop("checked",e),createCompareAttributesTable(compare_products_data,jQuery("#compare-attributes"))}function getSkusFromUrl(){let e=window.location.pathname.split("/"),t=[];if(e.length>=3&&"so-sanh"===e[1]){e[2].split(";").forEach(e=>{let a=e.split(".").pop();t.push(a)})}return t}function getProductDetailsFromSkus(e){return new Promise((t,a)=>{let c=e.map(e=>new Promise((t,a)=>{jQuery.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"get_product_by_sku",sku:e,nonce:ThemeVars.nonce},success:function(e){e.success?t(e.data):a("Lỗi: "+e.data)},error:function(){a("Lỗi AJAX")}})}));Promise.all(c).then(e=>{t(e)}).catch(e=>{a(e)})})}jQuery(document).on("change",".checkdiff-cb",function(e){if(compare_products_data.length<2)return void jQuery(this).prop("checked",!1);let t=jQuery(this).is(":checked");createCompareAttributesTable(compare_products_data,jQuery("#compare-attributes")),syncCheckboxes(t)});