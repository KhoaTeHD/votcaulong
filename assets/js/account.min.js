jQuery(document).ready(function(e){let t=null,n={};function a(e){e&&e.addClass("loading")}function r(e){e&&e.removeClass("loading")}function s(e,t){e&&(t?(e.prop("disabled",!0),e.data("original-text",e.html()),e.html('<span class="spinner-border spinner-border-sm me-1"></span> Đang xử lý...')):(e.prop("disabled",!1),e.data("original-text")&&e.html(e.data("original-text"))))}function i(t,n,a,r,s){t.empty().append(e("<option>",{value:"",text:a})).prop("disabled",!0),Array.isArray(n)&&0!==n.length&&(n.forEach(n=>{t.append(e("<option>",{value:n[r]||n,text:n[s]||n}))}),t.prop("disabled",!1))}function o(t,n){let a=!1;return n?(t.find("option").each(function(){if(e(this).text().trim().toLowerCase()===n.trim().toLowerCase()||e(this).val().trim().toLowerCase()===n.trim().toLowerCase())return e(this).prop("selected",!0),a=!0,!1}),a):a}function d(t,s){t?n[t]?"function"==typeof s&&s(n[t]):e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",dataType:"json",data:{action:"get_erp_wards",nonce:ThemeVars.nonce,location:t},beforeSend:function(){a(e("#shipping_ward_new"))},success:function(a){r(e("#shipping_ward_new")),a.success&&Array.isArray(a.data)?(n[t]=a.data,"function"==typeof s&&s(a.data)):(siteNotify("Không thể tải danh sách Phường/Xã.","error"),"function"==typeof s&&s([]))},error:function(){r(e("#shipping_ward_new")),siteNotify("Không thể tải danh sách Phường/Xã.","error"),"function"==typeof s&&s([])}}):"function"==typeof s&&s([])}function c(n,s,c,l){var u;u=function(e){i(n,e,"-- Chọn Tỉnh/Thành phố - Quận/Huyện --","name","name"),c&&o(n,c)&&d(c,function(e){i(s,e,"-- Chọn Phường/Xã --","name","ward"),l&&o(s,l)})},t?"function"==typeof u&&u(t):e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",dataType:"json",data:{action:"get_erp_locations",nonce:ThemeVars.nonce},beforeSend:function(){a(e("#shipping_location"))},success:function(n){r(e("#shipping_location")),n.success&&Array.isArray(n.data)?(t=n.data,"function"==typeof u&&u(t)):(siteNotify("Không thể tải danh sách Tỉnh/Thành phố.","error"),"function"==typeof u&&u(null))},error:function(){r(e("#shipping_location")),siteNotify("Không thể tải danh sách Tỉnh/Thành phố.","error"),"function"==typeof u&&u(null)}}),n.on("change",function(){const t=e(this).val();s.empty().append('<option value="">-- Chọn Phường/Xã --</option>').prop("disabled",!0),t&&d(t,function(e){i(s,e,"-- Chọn Phường/Xã --","name","ward")})})}e(document).on("click",".sign-out-btn",function(t){t.preventDefault();let n=e(this);e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"logout",nonce:ThemeVars.nonce},beforeSend:function(){s(n,!0)},success:function(e){e.success?window.location.href=e.data.redirect:siteNotify("Lỗi khi đăng xuất: "+e.data.message,"error"),s(n,!1)},error:function(e){siteNotify("Lỗi AJAX khi đăng xuất","error")}})}),e(".togglePassword i").click(function(){let t=e(this).parent().siblings("input");const n="password"===t.attr("type")?"text":"password";t.attr("type",n),"password"===n?e(this).addClass("bi-eye-slash").removeClass("bi-eye"):e(this).addClass("bi-eye").removeClass("bi-eye-slash")}),e("#formToggle-btn").click(function(){let t=e(this).text(),n=e(this).data("login"),a=e(this).data("register");const r=e(".register_login_form-wrapper .left-col .overlay");r.css("opacity",1),setTimeout(()=>{if(t===n){e(".register_login_form-wrapper").addClass("login-form").removeClass("register-form"),e(".register_login_form-wrapper .left-col .register-text").fadeIn(),e(".register_login_form-wrapper .left-col .login-text").hide(),e(this).text(a);let t=e("#register-frm-wrapper");t.find(".form-title").addClass("title-move-down"),setTimeout(()=>{t.hide()},500),t.css("opacity",0),setTimeout(()=>{t.find(".form-title").removeClass("title-move-down"),e("#login-frm-wrapper").show().css("opacity",1)},200)}else{e(".register_login_form-wrapper").addClass("register-form").removeClass("login-form"),e(".register_login_form-wrapper .left-col .register-text").hide(),e(".register_login_form-wrapper .left-col .login-text").fadeIn(),e(this).text(n);let t=e("#login-frm-wrapper");t.find(".form-title").addClass("title-move-down"),setTimeout(()=>{t.hide()},500),t.css("opacity",0),setTimeout(()=>{t.find(".form-title").removeClass("title-move-down"),e("#register-frm-wrapper").show().css("opacity",1)},200)}},500),setTimeout(()=>{r.css("opacity",.6)},500)}),e(".formToggle-btn").on("click",function(t){t.preventDefault(),e("#formToggle-btn").trigger("click")}),e("#frm-login").on("submit",function(t){t.preventDefault();let n=!0,a=e(this);a.find(".error").removeClass("error");let r=a.find('button[type="submit"]'),i=a.find('input[name="email_phone_number"]').val(),o=a.find('input[name="password"]').val();if(""===i&&(n=!1,a.find('input[name="email_phone_number"]').addClass("error")),""===o&&(n=!1,a.find('input[name="password"]').addClass("error")),!n)return!1;e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"custom_login",nonce:ThemeVars.nonce,email_phone_number:i,password:o},beforeSend:function(){s(r,!0)},success:function(e){e.success?window.location.href=e.data.redirect:siteNotify(e.data.message,"error"),s(r,!1)}})}),e("#frm-register").on("submit",function(t){t.preventDefault();let n=e(this),a=n.find('button[type="submit"]');n.find(".error").removeClass("error");let r=!0,i=n.find('input[name="register_fullname"]').val(),o=n.find('input[name="email_phone_number"]').val(),d=n.find('input[name="password"]').val(),c=n.find('input[name="repeat-password"]').val();if(""===i&&(r=!1,n.find('input[name="register_fullname"]').addClass("error")),""===o&&(r=!1,n.find('input[name="email_phone_number"]').addClass("error")),""!==d&&""!==c||(r=!1,n.find('input[name="password"]').addClass("error")),d!==c&&(r=!1,n.find('input[name="password"]').addClass("error"),n.find('input[name="repeat-password"]').addClass("error")),!r)return!1;e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"custom_register",nonce:ThemeVars.nonce,fullname:i,email_or_phone:o,password:d},beforeSend:function(){s(a,!0)},success:function(e){e.success?(siteNotify(e.data.message),setTimeout(function(){window.location.href=e.data.redirect},3e3)):(siteNotify(e.data.message,"error"),s(a,!1))},error:function(){siteNotify("Đã có lỗi xảy ra khi gửi yêu cầu. Vui lòng thử lại.","error"),s(a,!1)}})}),e("#frm-forgot-password").on("submit",function(t){t.preventDefault();let n=e(this),a=e("#btn-reset-password"),r=e("#forgot-password-error");r.addClass("d-none").text("");let i=n.find('input[name="user_login"]').val().trim();if(""===i)return r.text("Vui lòng nhập email hoặc số điện thoại.").removeClass("d-none"),!1;e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"vcl_forgot_password",nonce:ThemeVars.nonce,user_login:i},beforeSend:function(){s(a,!0)},success:function(t){t.success?(siteNotify(t.data.message),e("#forgotPasswordModal").modal("hide"),n[0].reset()):(r.text(t.data.message).removeClass("d-none"),siteNotify(t.data.message,"error"))},error:function(){r.text("Lỗi kết nối. Vui lòng thử lại.").removeClass("d-none"),siteNotify("Lỗi kết nối máy chủ.","error")},complete:function(){s(a,!1)}})}),e("#avatar-input").change(function(t){let n=t.target.files[0],a=new FileReader;a.onload=function(t){e("#avatar-preview").attr("src",t.target.result)},a.readAsDataURL(n)});e("#update-account-form").submit(function(t){t.preventDefault();let n=e(this),i=e(this).find('button[type="submit"]'),o=!0;n.find(".error").removeClass("error"),n.find(".error-message").remove();let d=n.find('input[name="fullname"]').val().trim(),c=n.find('input[name="gender"]:checked').length>0,l=n.find('input[name="phone_number"]').val().trim();if(""===d&&(o=!1,n.find('input[name="fullname"]').addClass("error")),c||(o=!1,n.find('input[name="gender"]').closest(".col-sm-9").addClass("error")),""===l&&(o=!1,n.find('input[name="phone_number"]').addClass("error")),!o)return siteNotify("Vui lòng điền đầy đủ các trường bắt buộc.","error"),!1;let u=new FormData(this);u.append("nonce",ThemeVars.nonce),e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:u,contentType:!1,processData:!1,beforeSend:function(){s(i,!0),a()},success:function(e){e.success?siteNotify(e.data.message):siteNotify(e.data.message,"error")},error:function(e){siteNotify("Đã có lỗi xảy ra. Vui lòng thử lại sau.","error")},complete:function(){s(i,!1),r()}})});e("#change-password-form").submit(function(t){t.preventDefault();let n=e(this),i=e(this).find('button[type="submit"]'),o=!0;n.find(".error").removeClass("error"),n.find(".error-message").remove();let d=n.find('input[name="current_password"]').val(),c=n.find('input[name="new_password"]').val(),l=n.find('input[name="confirm_new_password"]').val();if(""===d&&(o=!1,n.find('input[name="current_password"]').addClass("error"),siteNotify("Vui lòng nhập mật khẩu hiện tại.","error")),""===c&&(o=!1,n.find('input[name="new_password"]').addClass("error"),siteNotify("Vui lòng nhập mật khẩu mới.","error")),""===l&&(o=!1,n.find('input[name="confirm_new_password"]').addClass("error"),siteNotify("Vui lòng xác nhận mật khẩu mới.","error")),c!==l&&(o=!1,n.find('input[name="new_password"]').addClass("error"),n.find('input[name="confirm_new_password"]').addClass("error"),siteNotify("Mật khẩu mới và xác nhận mật khẩu không khớp.","error")),c.length<6&&(o=!1,n.find('input[name="new_password"]').addClass("error"),siteNotify("Mật khẩu mới phải có ít nhất 6 ký tự.","error")),!o)return!1;e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"vcl_change_password",nonce:ThemeVars.nonce,current_password:d,new_password:c},beforeSend:function(){s(i,!0),a()},success:function(e){e.success?(siteNotify(e.data.message),n[0].reset(),e.data.redirect&&setTimeout(function(){window.location.href=e.data.redirect},1e3)):siteNotify(e.data.message,"error")},error:function(e){siteNotify("Đã có lỗi xảy ra. Vui lòng thử lại sau.","error")},complete:function(){s(i,!1),r()}})});let l="undefined"!=typeof AccountProfileVars&&AccountProfileVars.savedShippingLocation?AccountProfileVars.savedShippingLocation:"",u="undefined"!=typeof AccountProfileVars&&AccountProfileVars.savedShippingWard?AccountProfileVars.savedShippingWard:"",f="undefined"!=typeof AccountProfileVars&&AccountProfileVars.savedBillingLocation?AccountProfileVars.savedBillingLocation:"",p="undefined"!=typeof AccountProfileVars&&AccountProfileVars.savedBillingWard?AccountProfileVars.savedBillingWard:"";e("#shipping_location").length&&e("#shipping_ward_new").length&&c(e("#shipping_location"),e("#shipping_ward_new"),l,u),e("#billing_location").length&&e("#billing_ward").length&&c(e("#billing_location"),e("#billing_ward"),f,p);const m=e("#customer-address-list"),h=e("#no-addresses-message"),g=document.getElementById("address-modal"),y=g?new bootstrap.Modal(g):null,_=e("#address-form"),v=e("#addressModalLabel"),b=e("#address_id"),w=e("#recipient_name"),x=e("#recipient_phone"),C=e("#street"),T=e("#is_default"),V=e("#btn-save-address"),N=e("#shipping_location"),k=e("#shipping_ward_new"),A=e("#address-form-error");let P=AccountAddressVars.addresses||[];function S(e){m.empty(),e&&0!==e.length?(h.hide(),e.forEach(e=>{const t=1==e.is_default||"1"==e.is_default,n=t?"border-primary":"",a=t?'<span class="badge bg-primary ms-2">Mặc định</span>':"",r=`\n                data-address-id="${e.id}"\n                data-recipient-name="${e.recipient_name||""}"\n                data-recipient-phone="${e.recipient_phone||""}"\n                data-location-name="${e.location_name||""}"\n                data-ward-name="${e.ward_name||""}"\n                data-street="${e.street||""}"\n                data-is-default="${t?"1":"0"}"\n            `;let s=e.ward_name||"";s.includes("-")&&(s=s.split("-").slice(0,-1).join("-").trim());const i=`\n                <div class="card address-card mb-3 ${n}" ${r}>\n                    <div class="card-body">\n                        <div class="d-flex justify-content-between">\n                            <div>\n                                <span class="fw-bold me-2">${e.recipient_name||""}</span> |\n                                <span class="ms-2 text-muted">${e.recipient_phone||""}</span>\n                                ${a}\n                            </div>\n                            <div>\n                                <button type="button" class="btn btn-link btn-sm text-primary p-0 me-2 btn-edit-address" data-address-id="${e.id}" data-bs-toggle="modal" data-bs-target="#address-modal" title="Sửa">Sửa</button>\n                                ${t?"":`<button type="button" class="btn btn-link btn-sm text-danger p-0 btn-delete-address" data-address-id="${e.id}" title="Xóa">Xóa</button>`}\n                            </div>\n                        </div>\n                        <p class="card-text text-muted mb-1">\n                            ${e.street||""},\n                            ${s},\n                            ${e.location_name||""}\n                        </p>\n                        ${t?"":`<button type="button" class="btn btn-outline-secondary btn-sm mt-2 btn-set-default-address" data-address-id="${e.id}">Đặt làm mặc định</button>`}\n                    </div>\n                </div>\n            `;m.append(i)})):h.show()}function j(t="add",n=null){_[0].reset(),N.val(""),k.empty().append(e("<option>",{value:"",text:"-- Chọn Phường/Xã --"})).prop("disabled",!0),A.hide().text(""),_.find(".error").removeClass("error"),b.val(""),"add"===t?(v.text("Thêm địa chỉ mới"),b.val(""),T.prop("checked",0===P.length)):"edit"===t&&n&&(v.text("Chỉnh sửa địa chỉ"),b.val(n.id),w.val(n.recipient_name),x.val(n.recipient_phone),C.val(n.street),T.prop("checked",n.is_default),o(N,n.location_name)?d(n.location_name,function(){N.trigger("change"),setTimeout(()=>{o(k,n.ward_name)},100)}):k.prop("disabled",!0)),y&&y.show()}e("#btn-add-new-address").on("click",function(){j("add")}),m.on("click",".btn-edit-address",function(){const t=e(this).closest(".address-card").data("address-id"),n=P.find(e=>e.id==t);n?j("edit",n):siteNotify("Không tìm thấy địa chỉ để sửa.","error")}),m.on("click",".btn-delete-address",function(){const t=e(this).closest(".address-card"),n=t.data("address-id"),r=t.data("recipient-name");confirm(`Bạn có chắc chắn muốn xóa địa chỉ của "${r}"?`)&&e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",data:{action:"vcl_delete_address",nonce:AccountAddressVars.deleteNonce,address_id:n},beforeSend:function(){a(t)},success:function(e){e.success?(siteNotify(e.data.message||"Xóa địa chỉ thành công!"),P=e.data.addresses||[],S(P)):siteNotify(e.data.message||"Xóa địa chỉ thất bại.","error")},error:function(){siteNotify("Lỗi kết nối máy chủ.","error")}})}),m.on("click",".btn-set-default-address",function(){const t=e(this),n=t.closest(".address-card").data("address-id");e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",data:{action:"vcl_set_default_address",nonce:AccountAddressVars.setDefaultNonce,address_id:n},beforeSend:function(){s(t,!0)},success:function(e){e.success?(siteNotify(e.data.message||"Đặt làm mặc định thành công!"),P=e.data.addresses||[],S(P)):siteNotify(e.data.message||"Đặt làm mặc định thất bại.","error")},error:function(){siteNotify("Lỗi kết nối máy chủ.","error")}})}),_.on("submit",function(t){t.preventDefault(),A.text("").addClass("d-none");let n=!0;if(e(this).find("[required]").each(function(){e(this).val()?e(this).removeClass("is-invalid"):(n=!1,e(this).addClass("is-invalid"))}),!n)return void A.text("Vui lòng điền đầy đủ các trường bắt buộc.").removeClass("d-none");const i=e(this).serializeArray(),o={action:"vcl_save_address",nonce:AccountAddressVars.saveNonce};i.forEach(e=>{o[e.name]=e.value}),o.is_default=T.is(":checked")?"1":"0",e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",data:o,beforeSend:function(){s(V,!0),a(_)},success:function(e){e.success?(siteNotify(e.data.message||"Lưu địa chỉ thành công!"),P=e.data.addresses||[],S(P),y&&y.hide()):(A.text(e.data.message||"Đã có lỗi xảy ra.").removeClass("d-none"),siteNotify(e.data.message||"Lưu địa chỉ thất bại.","error"))},error:function(){A.text("Lỗi kết nối. Vui lòng thử lại.").removeClass("d-none"),siteNotify("Lỗi kết nối máy chủ.","error")},complete:function(){s(V,!1),r(_)}})}),N.on("change",function(){const n=e(this).val();k.empty().append('<option value="">-- Chọn Phường/Xã --</option>').prop("disabled",!0),n&&t&&d(n,function(e){i(k,e,"-- Chọn Phường/Xã --","name","ward")})}),S(P),e(".order-make-payment").click(function(t){t.preventDefault();const n=e(this).data("orderid");n&&e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"order_manual_payment",nonce:ThemeVars.nonce,orderid:n},beforeSend:function(){a()},success:function(e){r(),e.success?(siteNotify(e.data.message),e.data.redirect_url&&(window.location.href=e.data.redirect_url)):siteNotify(e.data.message)},error:function(){r(),siteNotify("Lỗi kết nối máy chủ.")}})}),e(document).on("click",".order-make-cancel",function(t){t.preventDefault();const n=e(this).data("orderid");e("#confirmCancelOrderBtn").data("orderid",n),e("#cancel-reason").val("").removeClass("is-invalid"),e("#cancel-reason-feedback").text("");new bootstrap.Modal(document.getElementById("cancelOrderModal")).show()}),e(document).on("click","#confirmCancelOrderBtn",function(t){t.preventDefault();const n=e(this).data("orderid"),a=e("#cancel-reason").val().trim(),r=e("#cancel-reason"),i=e("#cancel-reason-feedback"),o=e(this);if(""===a)return r.addClass("is-invalid"),void i.text("Vui lòng nhập lý do hủy đơn hàng.").show();r.removeClass("is-invalid"),i.text("").hide(),e.ajax({url:ThemeVars.ajaxurl,type:"POST",data:{action:"vcl_cancel_order",nonce:ThemeVars.nonce,order_id:n,customer_note:a},beforeSend:function(){s(o,!0)},success:function(e){e.success?(siteNotify(e.data.message||"Đơn hàng đã được hủy thành công."),setTimeout(function(){location.reload()},1e3)):siteNotify(e.data.message||"Không thể hủy đơn hàng.","error")},error:function(){siteNotify("Lỗi kết nối máy chủ khi hủy đơn hàng.","error")},complete:function(){s(o,!1);const e=bootstrap.Modal.getInstance(document.getElementById("cancelOrderModal"));e&&e.hide()}})})});