jQuery(document).ready(function(e){function t(){e("#loading-overlay").show(),e("#btn-checkout, #btn-checkout-with-card").prop("disabled",!0)}function n(){e("#loading-overlay").hide(),e("#btn-checkout, #btn-checkout-with-card").prop("disabled",!1)}function i(e){jQuery("#siteNotify .toast-body").text(e),new bootstrap.Toast(jQuery("#siteNotify")[0]).show()}let a=null,o={};function r(o){a?"function"==typeof o&&o(a):e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",dataType:"json",data:{action:"get_erp_locations",nonce:ThemeVars.nonce},beforeSend:function(){t(e("#shipping_location"))},success:function(t){n(e("#shipping_location")),t.success&&Array.isArray(t.data)?(a=t.data,"function"==typeof o&&o(a)):(i("Không thể tải danh sách Tỉnh/Thành phố."),"function"==typeof o&&o(null))},error:function(){n(e("#shipping_location")),i("Không thể tải danh sách Tỉnh/Thành phố."),"function"==typeof o&&o(null)}})}function c(a,r){a?o[a]?"function"==typeof r&&r(o[a]):e.ajax({url:AccountAddressVars.ajaxUrl,type:"POST",dataType:"json",data:{action:"get_erp_wards",nonce:ThemeVars.nonce,location:a},beforeSend:function(){t(e("#shipping_ward_new"))},success:function(t){n(e("#shipping_ward_new")),t.success&&Array.isArray(t.data)?(o[a]=t.data,"function"==typeof r&&r(t.data)):(i("Không thể tải danh sách Phường/Xã."),"function"==typeof r&&r([]))},error:function(){n(e("#shipping_ward_new")),i("Không thể tải danh sách Phường/Xã."),"function"==typeof r&&r([])}}):"function"==typeof r&&r([])}function s(t,n,i,a,o,r=!1){t.empty().append(e("<option>",{value:"",text:i})),Array.isArray(n)&&0!==n.length?(n.forEach(n=>{let i=n[o]||n;r&&i.includes("-")&&(i=i.substring(0,i.lastIndexOf("-")).trim()),t.append(e("<option>",{value:n[a]||n,text:i}))}),t.prop("disabled",!1)):t.prop("disabled",!0)}function l(t,n){if(!n||!t)return!1;const i=n.toLowerCase().trim();let a=!1;return t.find("option").each(function(){if(e(this).text().toLowerCase().trim()===i||i===e(this).val().toLowerCase())return e(this).prop("selected",!0),a=!0,!1}),a&&t.trigger("change"),a}function p(i){let a=e("#shipping-method-cost-list");a.html('<div class="text-muted p-2">Đang tải phí vận chuyển...</div>'),e.ajax({url:ThemeVars.ajaxurl,type:"POST",dataType:"json",data:{action:"get_shipping_cost",nonce:ThemeVarsCheckout.vcl_checkout_nonce,address_line1:i.address_line1,custom_address_location:i.custom_address_location,custom_ward:i.custom_ward,cart_total:e("#cartPage-subtotal .subtotal-value").data("value")},beforeSend:function(){t()},success:function(e){if(e.success&&e.data&&e.data.shipping_cost){let t=e.data.shipping_cost,n="",i="",o=0,r=!0;Object.entries(t).forEach(([e,t])=>{n+=`\n                        <label class="me-3 mb-2">\n                            <input type="radio" name="shipping_service" value="${e}" ${r?"checked":""}>\n                            <span class="fw-bold">${e}</span>\n                            <span class="text-primary ms-1">${t.toLocaleString("vi-VN")} đ</span>\n                        </label>\n                    `,r&&(i=e,o=t,r=!1)}),a.html(n||'<div class="text-danger p-2">Không có phương thức vận chuyển khả dụng!</div>'),i&&v(i,o)}else a.html('<div class="text-danger p-2">Không thể lấy phí vận chuyển!</div>');n()},error:function(){e("#shipping-method-cost-list").html('<div class="text-danger p-2">Lỗi kết nối khi lấy phí vận chuyển!</div>'),n()}})}const d=e("#shipping_location"),h=e("#shipping_ward_new"),u=e("#shipping-address");let _="",g="",m=AccountAddressVars.addresses||[];function v(t,n){e(".shipping-line .shipping-method-name").text(t?`(${t})`:""),e(".shipping-line .cartpageTotal-value").html(`${n.toLocaleString("vi-VN")}<sup>₫</sup>`);let i=e("#cartPage-subtotal .subtotal-value").data("value"),a=0;e("#cartPage-total .orderPromotions").each(function(){let t=e(this).data("value");a+=parseInt(t)});let o=(parseInt(i,10)||0)+n-a;e(".total-line .cartpageTotal-value").html(`${o.toLocaleString("vi-VN")}<sup>₫</sup>`)}var f,y,b,k,w;m.length?m.forEach(function(t){t.is_default&&(_=t.location_code||t.location_name||"",g=t.ward_code||t.ward_name||"",e("#street").val(t.street))}):(_=u.data("prefill-city")||"",g=u.data("prefill-ward")||""),e("#shipping-method-cost-list").on("change",'input[name="shipping_service"]',function(){v(e(this).val(),parseInt(e(this).siblings(".text-primary").text().replace(/[^\d]/g,""),10)||0)}),f=d,y=h,b=_,k=g,r(function(e){s(f,e,"-- Chọn Tỉnh/Thành phố --","name","name"),f.select2();let t=!1;b&&l(f,b)&&(t=!0,c(b,function(e){s(y,e,"-- Chọn Phường/Xã --","name","ward",!0),k&&l(y,k),y.select2(),"function"==typeof w&&w()})),t||"function"!=typeof w||w()}),f.off("change").on("change",function(){const t=e(this).val();y.empty().append('<option value="">-- Chọn Phường/Xã --</option>').prop("disabled",!0),y.hasClass("select2-hidden-accessible")&&y.select2("destroy"),t&&c(t,function(e){s(y,e,"-- Chọn Phường/Xã --","name","ward",!0),y.select2()})});let x=null;e("#shipping_ward_new, #street").on("change blur",function(){clearTimeout(x),x=setTimeout(function(){if("delivery"===e('input[name="shipping_method"]:checked').val()){let t=e("#street").val()||"",n=e("#shipping_location option:selected").val()||"",i=e("#shipping_ward_new").val()||"";t&&n&&i?p({address_line1:t,custom_address_location:n,custom_ward:i}):e("#shipping-method-cost-list").html('<div class="text-danger p-2">Vui lòng nhập đủ địa chỉ để tính phí vận chuyển.</div>')}},400)});e("#delivery"),e("#pickup");const T=e("#store-list-container"),j=(e("#shipping-address"),e("#shipping-method")),V=e("#address-search").closest(".mb-3");T.hide(),V.hide();const C=e("#address-search"),P=T.find("li");C.on("input",function(){const t=e(this).val().toLowerCase();P.each(function(){const n=e(this).data("address").toLowerCase(),i=e(this);""===t||n.includes(t)?i.show():i.hide()})}),e('input[name="shipping_method"]').on("change",function(){if("pickup"===e(this).val())T.slideDown(),V.slideDown(),u.slideUp(),j.slideUp();else{T.slideUp(),V.slideUp(),u.slideDown(),j.slideDown(),a||r();let t={address_line1:e("#street").val()||"",custom_address_location:e("#shipping_location option:selected").val()||"",custom_ward:e("#shipping_ward_new").val()||""};t.custom_address_location&&t.custom_ward&&p(t)}});const S=e("#other-recipient-info"),$=e("#company-invoice-info"),A=e("#other_recipient"),L=e("#company_invoice");function Q(){const a=e('#shipping-method-cost-list input[name="shipping_service"]:checked'),o={customer_info:{gender:e('input[name="gender"]:checked').val(),fullname:e("#fullname").val(),phone_number:e("#phone_number").val(),email:e("#email").val()},shipping_total:parseInt(a.siblings(".text-primary").text().replace(/[^\d]/g,""),10)||0,voucher_code:"",order_rule:"",loyalty_point:0,cart:getCart(),items_rule:[]};return e("#input_voucher_code").val()&&(o.voucher_code=e("#input_voucher_code").val()),e('input[name="order_pricing_rule"]:checked').val()&&(o.order_rule=e('input[name="order_pricing_rule"]:checked').val()),parseInt(e("#input_redeem_loyalty").val())&&(o.loyalty_point=parseInt(e("#input_redeem_loyalty").val())),e("#cartPage-items .cartPage-item").each(function(){let t=e(this),n=t.data("variation-sku")||t.data("sku"),i=t.find(".item-promotions");if(i.length){let e=i.find('input[name="item_pricing_rule"]:checked').val();e&&o.items_rule.push({item_code:n,pricing_rule:e})}}),jQuery.ajax({url:ThemeVars.ajaxurl,method:"POST",data:{action:"refresh_checkout",order_data:o,nonce:ThemeVars.nonce},beforeSend:function(){t()},success:function(e){if(e.success){let t="";if(jQuery("#shoppingCart-page #cartPage-items").html(e.data.html),jQuery("#shoppingCart-page #cartPage-subtotal").html(e.data.subtotal_html),jQuery("#shoppingCart-page #cartPage-total").html(e.data.total_html),e.data.order_rules&&(jQuery(e.data.order_rules).each(function(e,n){t+=`<input type="radio" style="display: none;" ${o.order_rule===n.pricing_rule?"checked":""} name="order_pricing_rule" id="${n.pricing_rule}" value="${n.pricing_rule}"><label class="btn btn-outline-danger select_order_rules" role="button" for="${n.pricing_rule}"><i class="bi bi-ticket-detailed"></i> ${n.description}</label>`}),jQuery("#order_pricing_rule").html(t)),o.voucher_code){U("#apply_voucher_button",`<div class="voucher_applied discounts_applied"><span><i class="bi bi-ticket-detailed"></i> ${o.voucher_code} <i class="bi bi-x-lg ms-1 remove" role="button"></i></span></div>`)}if(o.loyalty_point){U("#redeem_loyalty_section",`<div class="loyalty_applied discounts_applied"><span><i class="bi bi-ticket-detailed"></i> ${o.loyalty_point} <i class="bi bi-x-lg ms-1 remove" role="button"></i></span></div>`)}}else console.error("Lỗi:",e.data),i(e.data)},error:function(e){console.error("Lỗi khi tải thông tin sản phẩm:",e),jQuery("#shoppingCart-page").html(`<p>${translations.cart_error}</p>`)},complete:function(){n()}})}function U(t,n){const i=e(t),a=e("#order_discounts_applied"),o=e(n);let r;if(o.hasClass("voucher_applied"))r="voucher_applied";else{if(!o.hasClass("loyalty_applied"))return void console.warn("Unknown discount type, skipping apply");r="loyalty_applied"}a.find("."+r).length>0||(a.append(o),i.find("input").prop("disabled",!0),i.hide())}S.hide(),$.hide(),A.on("change",function(){this.checked?S.slideDown():S.slideUp()}),L.on("change",function(){this.checked?$.slideDown():$.slideUp()}),Q().then(function(){const t=e("#street").val()||"",n=e("#shipping_location option:selected").val()||"",i=e("#shipping_ward_new").val()||"";t&&n&&i&&p({address_line1:t,custom_address_location:n,custom_ward:i})}),e("#order_discounts_applied").on("click",".discounts_applied .remove",function(){!function(t){const n=t.closest(".discounts_applied");let i;if(n.hasClass("voucher_applied"))i=e("#apply_voucher_button");else{if(!n.hasClass("loyalty_applied"))return void console.warn("Unknown discount type, skipping removal");i=e("#redeem_loyalty_section")}n.remove(),i.find('input[type="text"]').prop("disabled",!1).val(""),i.show(),Q()}(e(this))}),e("#order_pricing_rule").on("change",'input[name="order_pricing_rule"]',function(){Q()}),e(".refresh-checkout, #button-apply-voucher, #button-redeem-loyalty").on("click",function(){return Q(),!1}),e("#btn-checkout, #btn-checkout-with-card").on("click",function(){if(!e("#accept_privacy_policy").is(":checked"))return void i(translations.accept_privacy_policy_required||"Bạn phải đồng ý với chính sách bảo mật để tiếp tục.");const a=e('input[name="payment_method"]:checked');if(0===a.length)return void i(translations.payment_method_required||"Vui lòng chọn phương thức thanh toán.");const o=a.val(),r=a.data("title")||a.closest("label").text().trim()||o,c={customer_info:{gender:e('input[name="gender"]:checked').val(),fullname:e("#fullname").val(),phone_number:e("#phone_number").val(),email:e("#email").val()},shipping_method:e('input[name="shipping_method"]:checked').val(),shipping_address:null,pickup_store_id:null,order_note:e("#order_note").val(),other_recipient:null,how_to_use:e("#how_to_use").is(":checked"),company_invoice:null,voucher_code:e("#input_voucher_code").val(),loyalty_point:parseInt(e("#input_redeem_loyalty").val()),order_pricing_rule:null,payment_method:o,payment_method_title:r,shipping_service:null,shipping_total:null,cart:getCart(),items_rule:[]};e('input[name="order_pricing_rule"]:checked').val()&&(c.order_pricing_rule=e('input[name="order_pricing_rule"]:checked').val()),e("#cartPage-items .cartPage-item").each(function(){let t=e(this),n=t.data("variation-sku")||t.data("sku"),i=t.find(".item-promotions")||null;if(i){let e=i.find('input[name="item_pricing_rule"]:checked').val();e&&c.items_rule.push({item_code:n,pricing_rule:e})}});let s=!0;if("delivery"===c.shipping_method){c.shipping_address={city_code:e("#shipping_location").val(),city_name:e("#shipping_location option:selected").text(),ward_code:e("#shipping_ward_new").val(),ward_name:e("#shipping_ward_new option:selected").text(),street:e("#street").val()};const t=e('#shipping-method-cost-list input[name="shipping_service"]:checked');c.shipping_service=t.val(),c.shipping_total=parseInt(t.siblings(".text-primary").text().replace(/[^\d]/g,""),10)||0,c.shipping_address.city_code&&c.shipping_address.ward_code&&c.shipping_address.street||(i(translations.shipping_address_required||"Vui lòng nhập đầy đủ thông tin địa chỉ giao hàng."),s=!1),t.length||(i("Vui lòng chọn phương thức vận chuyển!"),s=!1)}else"pickup"===c.shipping_method&&(c.pickup_store_id=e('input[name="selected_store"]:checked').val(),c.pickup_store_id||(i(translations.pickup_store_required||"Vui lòng chọn cửa hàng để nhận hàng."),s=!1));if(c.customer_info.fullname&&c.customer_info.phone_number||(i(translations.customer_info_required||"Vui lòng nhập đầy đủ Họ tên và Số điện thoại."),s=!1),e("#other_recipient").is(":checked")&&(c.other_recipient={title:e('input[name="other_recipient_title"]:checked').val(),name:e("#other_recipient_name").val(),phone:e("#other_recipient_phone").val()},c.other_recipient.name&&c.other_recipient.phone||(i(translations.other_recipient_required||"Vui lòng nhập đầy đủ thông tin người nhận khác."),s=!1)),e("#company_invoice").is(":checked")&&(c.company_invoice={name:e("#company_name").val(),tax_number:e("#company_tax_number").val(),address:e("#company_address").val()},c.company_invoice.name&&c.company_invoice.tax_number&&c.company_invoice.address||(i(translations.company_invoice_required||"Vui lòng nhập đầy đủ thông tin xuất hóa đơn công ty."),s=!1)),!s)return;let l="";switch(o){case"cod":l="process_cod_order";break;case"payoo":l="process_payoo_order";break;case"vnpay":l="process_vnpay_order";break;default:return void i("Phương thức thanh toán không hợp lệ.")}e.ajax({url:ThemeVars.ajaxurl,method:"POST",data:{action:l,nonce:ThemeVarsCheckout.vcl_checkout_nonce,order_data:JSON.stringify(c)},beforeSend:function(){t()},success:function(e){n(),e.success?(i(e.data.message||"Yêu cầu đặt hàng đã được gửi!"),saveCart([]),e.data.redirect_url?window.location.href=e.data.redirect_url:e.data.order_received_url?window.location.href=e.data.order_received_url:window.location.href="/"):i(e.data.message||"Đã xảy ra lỗi khi xử lý đơn hàng. Vui lòng thử lại.")},error:function(e,t,a){n(),i("Đã xảy ra lỗi kết nối khi gửi yêu cầu đặt hàng. Vui lòng kiểm tra kết nối mạng và thử lại.")}})})});