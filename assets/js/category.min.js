jQuery(document).ready(function(t){const e=t('<div class="spinner-overlay d-flex justify-content-center" id="psort-spinner"><div class="spinner-grow" aria-hidden="true"></div></div>'),n=t("#product-container"),a=t("#activeFilters");function o(){let e={};return t(".filter-checkbox:checked").each(function(){const n=t(this).attr("name"),a=t(this).val();e[n]||(e[n]=[]),e[n].push(a)}),t('input[name="product-sort"]:checked').each(function(){const n=t(this).attr("name"),a=t(this).val();e[n]=a}),e}function i(){const e=o(),n=new URLSearchParams(window.location.search),a=n.get("page");let i=["filter_price","filter_brands","filter_branches","product-sort"];t(".filter-checkbox").each(function(){const e=t(this).attr("name");e&&!i.includes(e)&&i.push(e)}),i.forEach(t=>n.delete(t));for(const t in e)Array.isArray(e[t])?e[t].length>0&&n.set(t,e[t].join(",")):n.set(t,e[t]);a?n.set("page",a):n.delete("page");const r=`${window.location.pathname}?${n.toString()}`;history.pushState({path:r},"",r)}function r(){a.empty();const e=o();let n=!1;for(const o in e){if("product-sort"===o)continue;(Array.isArray(e[o])?e[o]:[e[o]]).forEach(e=>{n=!0;let i=e;const r=t(`input[name="${o}"][value="${e}"]`);if(r.length&&r.attr("id")){const n=t(`label[for="${r.attr("id")}"]`);n.length&&(i=(n.find(".title").text().trim()||n.text().trim()||e).replace(/<span class="count">\(\d+\)<\/span>/gi,"").trim())}const s=t(`\n                    <span class="active-filter-tag badge bg-success me-1 mb-1" data-filter-key="${o}" data-filter-value="${e}">\n                        ${i} <i class="bi bi-x-lg ms-1" role="button" style="cursor:pointer;"></i>\n                    </span>\n                `);s.find("i").on("click",function(){c(o,e)}),a.append(s)})}if(n){const e=t('<button class="clear-all-filters btn btn-sm btn-outline-danger me-2 p-0 px-3">Xóa tất cả</button>');e.on("click",function(){t(".filter-checkbox:checked").prop("checked",!1),s(!0)}),a.prepend(e)}}function c(e,n){const a=t(`input[name="${e}"][value="${n}"]`);a.is(":checkbox")&&a.prop("checked",!1),i(),s(!0)}function s(a=!1){let c=o(),s=t("#product-container").data("category_id"),l=t("#product-container").data("brands");if(s&&!c.filter_category&&(c.filter_category=[s]),l&&!c.brands&&(c.brands=[l]),a){const t=new URLSearchParams(window.location.search);t.delete("page");const e=`${window.location.pathname}?${t.toString()}`;history.replaceState({path:e},"",e)}i(),r();let p={action:"filter_products",filters:c,nonce:ThemeVars.nonce};const d=new URLSearchParams(window.location.search);!a&&d.has("page")&&(p.page=d.get("page")),t.ajax({url:ThemeVars.ajaxurl,type:"POST",data:p,beforeSend:function(){n.html(""),n.before(e)},success:function(e){n.html(e),t("#psort-spinner").fadeOut().remove(),updateCompareButtonStatus(),e.pagination&&t("#pagination_wrapper").html(e.pagination)},error:function(e){console.error("Error filtering products:",e),t("#psort-spinner").fadeOut().remove()}})}t('input[name="product-sort"]').on("change",function(){s(!0)}),t(".filter-checkbox").change(function(){s(!0)}),t(document).on("click",".product-pagination-small button",function(e){e.preventDefault();let n=t(this);t("#product-container").data("category_id");const a=t(".product-pagination-small span.page-numbers");let o=parseInt(a.data("current-page")),i=parseInt(a.data("total-pages"));const r=a.data("paged-var");let c=0;if(n.hasClass("page-prev-btn")?o>1&&(c=o-1):n.hasClass("page-next-btn")&&o<i&&(c=o+1),c&&c!==o){const t=new URL(window.location);return t.searchParams.set(r,c),history.pushState(null,"",t.toString()),console.log(t),void(window.location.href=t.toString())}}),t(document).on("mouseenter",".product-item .image-variations .variation-photo",function(e){let n=t(this),a=n.closest(".product-item"),o=a.find(".item-image img"),i=n.data("img");i&&o.length&&(a.data("original-src")||a.data("original-src",o.attr("src")),o.addClass("image-transitioning"),o.attr("src",i))}),t(document).on("mouseleave",".product-item .image-variations .variation-photo",function(e){let n=t(this).closest(".product-item"),a=n.find(".item-image img"),o=n.data("original-src");o&&a.length&&(a.addClass("image-transitioning"),a.attr("src",o),setTimeout(function(){a.removeClass("image-transitioning")},500))}),t(".mb-sortby-btn").on("click",function(e){e.preventDefault(),t(".product-sort-by").toggleClass("show")}),function(){const e=new URLSearchParams(window.location.search);let n=!1;e.forEach((e,a)=>{if("page"!==a&&"product-sort"!==a){e.split(",").forEach(e=>{const o=t(`input.filter-checkbox[name="${a}"][value="${e}"]`);o.length&&(o.prop("checked",!0),n=!0)})}else{const o=t(`input[name="${a}"][value="${e}"]`);o.length&&(o.prop("checked",!0),"page"!==a&&(n=!0))}}),r(),n&&s()}()});